#!/bin/bash
#
# Isolated Benchmark Management Script
#
# Simple bash wrapper for common benchmark operations.
# Provides convenient commands for managing isolated benchmarks.
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BENCHMARK_SCRIPT="$SCRIPT_DIR/benchmarks/benchmark_runner.py"

case "$1" in
    "setup")
        echo "üîß Setting up isolated benchmark environment..."
        python "$BENCHMARK_SCRIPT" --setup
        ;;
    
    "run")
        # Detect optional quick mode flag
        QUICK_FLAG=""
        if [ "$2" = "--quick" ]; then
            QUICK_FLAG="--quick"
            shift
        fi
        
        if [ -z "$2" ]; then
            echo "‚ùå Usage: $0 run [--quick] <commit> [benchmark_filter]"
            echo "Example: $0 run --quick HEAD GKPlusTreeInsert"
            exit 1
        fi
        
        COMMIT="$2"
        BENCH_FILTER=""
        if [ ! -z "$3" ]; then
            BENCH_FILTER="--bench $3"
        fi
        
        echo "üöÄ Running isolated benchmarks for $COMMIT${QUICK_FLAG:+ (quick mode)}..."
        python "$BENCHMARK_SCRIPT" --run "$COMMIT" $BENCH_FILTER $QUICK_FLAG
        ;;
    
    "status")
        python "$BENCHMARK_SCRIPT" --status
        ;;
    
    "stop")
        echo "üõë Stopping benchmarks..."
        python "$BENCHMARK_SCRIPT" --stop
        ;;
    
    "view")
        python "$BENCHMARK_SCRIPT" --view
        ;;
    
    "clean")
        python "$BENCHMARK_SCRIPT" --clean
        ;;
    
    "logs")
        BENCHMARK_DIR="$(dirname "$SCRIPT_DIR")/.isolated-benchmarks"
        LOG_DIR="$BENCHMARK_DIR/logs"
        
        if [ -d "$LOG_DIR" ]; then
            echo "üìã Recent benchmark logs:"
            ls -lt "$LOG_DIR"/*.log 2>/dev/null | head -5
            
            if [ ! -z "$2" ]; then
                echo -e "\nüìÑ Showing log: $2"
                if [ -f "$LOG_DIR/$2" ]; then
                    cat "$LOG_DIR/$2"
                else
                    echo "‚ùå Log file not found: $2"
                fi
            fi
        else
            echo "‚ùå No log directory found"
        fi
        ;;
    
    "help"|*)
        echo "üîß Isolated Benchmark Runner"
        echo ""
        echo "Usage: $0 <command> [options]"
        echo ""
        echo "Commands:"
        echo "  setup                    - Set up isolated benchmark environment"
        echo "  run <commit> [filter]    - Run benchmarks for specific commit"
        echo "  status                   - Show current benchmark status"
        echo "  stop                     - Stop running benchmarks"
        echo "  view                     - Open benchmark results in browser"
        echo "  logs [logfile]           - Show recent logs or specific log"
        echo "  clean                    - Clean up benchmark environment"
        echo "  help                     - Show this help"
        echo ""
        echo "Examples:"
        echo "  $0 setup                                    # Initial setup"
        echo "  $0 run HEAD                                 # Benchmark current commit"
        echo "  $0 run \"HEAD^!\"                             # Benchmark latest commit (best practice)"
        echo "  $0 run HEAD GKPlusTreeInsert               # Benchmark specific test"
        echo "  $0 run \"performance-refactor^!\"            # Benchmark latest on branch"
        echo "  $0 status                                   # Check progress"
        echo "  $0 view                                     # View results"
        echo ""
        echo "Features:"
        echo "  ‚úÖ Complete isolation from working directory"
        echo "  ‚úÖ Background execution (non-blocking)"
        echo "  ‚úÖ Local storage"
        echo "  ‚úÖ Progress tracking and logging"
        ;;
esac
